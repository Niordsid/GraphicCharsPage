<!DOCTYPE html>
<html>

<head>
  <title>Page 1</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <script src="resources/js/JQuery-3.2.1/jquery-3.2.1.min.js"></script>
  <script src="resources/js/rest.js"></script>
  <script src="resources/js/rest2.js"></script>
  <script src="resources/js/websocket.js"></script>

  <script src="resources/libraries/Highcharts-6.0.2/code/highcharts.js"></script>
  <script src="resources/libraries/Highcharts-6.0.2/code/modules/series-label.js"></script>
  <script src="resources/libraries/Highcharts-6.0.2/code/modules/exporting.js"></script>

  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="resources/css/bootstrap.min.css" media="screen,projection" />

  <script type="text/javascript">
    //------------------------------------------------------
    //  GLOBAL VARIABLES
    //------------------------------------------------------

    var students = [];
    var sessions = [];

    var selected_student = null;
    var selected_session = null;

    var chart = null;

    //------------------------------------------------------
    //  GLOBAL FUNCTIONS
    //------------------------------------------------------

    var initialize = function() {
      $('#session').prop('disabled', true);
      $('#plotGraphicBtn').prop('disabled', true);

      getListStudents(function(_students) {
        students = _students;
        renderStudents();
      });
    };

    var getListStudents = function(callback) {
      $.ajax({
          url: "https://api.arca.acacia.red/list/Student",
          method: 'GET',
          dataType: "json"
        })
        .done(callback)
        .fail(function(error) {
          console.error('Error', error);
        });
    };

    var getListSessions = function(student_id, callback) {
      $.ajax({
          url: "https://api.arca.acacia.red/list/sessions_of_student",
          method: 'POST',
          beforeSend: function(xhr) {
            xhr.setRequestHeader("Content-Type", "application/json");
          },
          data: JSON.stringify([student_id]),
          dataType: "json"
        })
        .done(callback)
        .fail(function(error) {
          console.error('Error', error);
        });
    };

    var renderStudents = function() {
      let html = "";
      for (let i = 0; i < students.length; i++) {
        html += '<option value="' + students[i]['Student'] + '">' + students[i]['Name'] + "</option>";
      }

      $('#student').append(html);

    }

    var renderSession = function() {
      let html = "";
      for (let i = 0; i < sessions.length; i++) {
        html += '<option value="' + sessions[i]['Session'] + '">' + sessions[i]['Session'] + "</option>";
      }

      $('#session').append(html);
    }

    var getGraphicData = function(student, session, callback) {
      $.ajax({
          url: "https://api.arca.acacia.red/plot/student_session/Emotion",
          method: 'POST',
          beforeSend: function(xhr) {
            xhr.setRequestHeader("Content-Type", "application/json");
          },
          data: {
            "Student": student,
            "Session": session
          },          
          dataType: "json"
        })
        .done(function(raw_data) {
          console.log('raw_data', raw_Data);
        })
        .fail(function(error) {
          console.error('Error', error);
        });

    };

    var plotGraphic = function() {

      if (selected_student) {
        if (selected_session) {

          getGraphicData(selected_student, selected_session, function(data) {
            if (chart) {
              chart.destroy();
            } else {
              chart = new Highcharts.chart('graphic', {

                title: {
                  text: 'Student "X"/Session "Y"'
                },

                subtitle: {
                  text: 'Student Emotions During The Session'
                },

                yAxis: {
                  title: {
                    text: 'EMOTION VALUE'
                  }
                },

                xAxis: {
                  title: {
                    text: 'OBSERVATIONS (OVER THE DURATION OF THE CLASS)'
                  }
                },

                legend: {
                  layout: 'vertical',
                  align: 'right',
                  verticalAlign: 'middle'
                },

                plotOptions: {
                  series: {
                    label: {
                      connectorAllowed: false
                    },
                    pointStart: 1
                  }
                },

                series: [{
                  name: 'Installation',
                  data: [43934, 52503, 57177, 69658, 97031, 119931, 137133, 154175]
                }, {
                  name: 'Manufacturing',
                  data: [24916, 24064, 29742, 29851, 32490, 30282, 38121, 40434]
                }, {
                  name: 'Sales & Distribution',
                  data: [11744, 17722, 16005, 19771, 20185, 24377, 32147, 39387]
                }, {
                  name: 'Project Development',
                  data: [null, null, 7988, 12169, 15112, 22452, 34400, 34227]
                }, {
                  name: 'Other',
                  data: [12908, 5948, 8105, 11248, 8989, 11816, 18274, 18111]
                }],

                responsive: {
                  rules: [{
                    condition: {
                      maxWidth: 500
                    },
                    chartOptions: {
                      legend: {
                        layout: 'horizontal',
                        align: 'center',
                        verticalAlign: 'bottom'
                      }
                    }
                  }]
                }

              });
            }
          });

        } else {
          alert('Please select a Session');
        }
      } else {
        alert('Please select a Student');
      }
    };

    //------------------------------------------------------
    //  DOCUMENT READY
    //------------------------------------------------------
    $(document).ready(function() {

      //------------------------------------------------------
      //  EVENTS
      //------------------------------------------------------

      $('#student').change(function() {
        selected_student = $(this).val() !== "" ? $(this).val() : null;

        if (selected_student) {
          getListSessions(selected_student, function(_sessions) {

            if (_sessions.length) {
              sessions = _sessions;
              $('#session').prop('disabled', false);
              renderSession();
            }


          });
        } else {
          $('#session').prop('disabled', true);
          $('#plotGraphicBtn').prop('disabled', true);
        }

      });

      $('#session').change(function() {
        selected_session = $(this).val() !== "" ? $(this).val() : null;

        if (selected_session) {
          $('#plotGraphicBtn').prop('disabled', false);
        } else {
          $('#plotGraphicBtn').prop('disabled', true);
        }

      });

      //------------------------------------------------------
      //  INITIALIZATION
      //------------------------------------------------------
      initialize();
    });
  </script>

</head>

<body>
  <div class="container" id="wrapper">

    <main role="main">
      <div class="col-lg-4">
        <div class="form-group">
          <select id="student" class="form-control" name="">
              <option value="">Choose Student</option>
            </select>
        </div>

        <div class="form-group">
          <select id="session" class="form-control" name="">
              <option value="">Choose Session</option>
            </select>
        </div>

        <div class="">
          <button id="plotGraphicBtn" type="button" name="button" class="btn btn-success" onclick="plotGraphic()">Plot Graphic</button>
        </div>
      </div>
      <div class="col-lg-12">
        <div class="graphic" style="width:100%; height:400px;">

        </div>
      </div>
    </main>
  </div>
</body>

</html>
